<!DOCTYPE html>
<!-- saved from url=(0276)file:///Users/rubyliu/Library/Containers/com.tencent.xinWeChat/Data/Library/Application%20Support/com.tencent.xinWeChat/2.0b4.0.9/65aa880a1a85acbe1975cd6ded770916/Message/MessageTemp/0f187609b441eaff1dd22929112856a1/OpenData/Shared%20VIP%20Card%20Expense%20Tracker%200814.html -->
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <title>Shared VIP Card Expense Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      /* max-width: 1200px;  */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 8px;
    }

    input,
    button {
      padding: 6px;
      margin: 4px;
    }

    .btn {
      background-color: green;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
    }

    .btn[disabled] {
      background-color: gray;
      cursor: not-allowed;
    }

    .balance-amount {
      font-weight: bold;
      color: red;
    }

    div {
      width: 100%;
      max-width: 1300px;
    }

    table {
      width: 100%;
    }

    #historyTable {
      margin-left: calc(-50vw + 50%);
      max-width: none;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <h2>Shared VIP Venue Card Tracker</h2>

  <div>
    <h3>Initialize Session</h3>
    <label>VIP Members (comma-separated):</label><input id="vipNames" placeholder="e.g., a,b,c,d"><br>
    <label>Initial balance per member:</label><input id="initialAmount" type="number" value="5750"><br>
    <button id="initBtn" onclick="initializeSession()" class="btn" disabled="">Initialize</button>
  </div>

  <div id="mainSection" style="display: block;">
    <h3>Record Expense</h3>
    <p>Session #: <span id="eventId">3</span></p>
    <label>Date:</label><input id="sessionDate" type="date"><br>
    <label>Hours Used:</label><input id="hours" type="number" value="2"><br>
    <div>
      <label>Time Period:</label>
      <input type="radio" id="peakTime" name="timePeriod" value="peak" checked="">
      <label for="peakTime">黄金时段 (280 RMB/hour)</label>
      <input type="radio" id="offPeakTime" name="timePeriod" value="offPeak">
      <label for="offPeakTime">非黄金时段 (190 RMB/hour)</label>
    </div><br>
    <div id="vipCheckboxes"><label>Select VIP Participants:</label><br><label><input type="checkbox" name="vipSelect"
          value="Blue"> Blue</label><input type="text" id="subs_Blue"
        placeholder="Substitutes for Blue (comma-separated)" style="margin-left: 10px; width: 200px;"><br><label><input
          type="checkbox" name="vipSelect" value="Guo"> Guo</label><input type="text" id="subs_Guo"
        placeholder="Substitutes for Guo (comma-separated)" style="margin-left: 10px; width: 200px;"><br><label><input
          type="checkbox" name="vipSelect" value="Pi"> Pi</label><input type="text" id="subs_Pi"
        placeholder="Substitutes for Pi (comma-separated)" style="margin-left: 10px; width: 200px;"><br><label><input
          type="checkbox" name="vipSelect" value="Eva"> Eva</label><input type="text" id="subs_Eva"
        placeholder="Substitutes for Eva (comma-separated)" style="margin-left: 10px; width: 200px;"><br><label><input
          type="checkbox" name="vipSelect" value="Vivian"> Vivian</label><input type="text" id="subs_Vivian"
        placeholder="Substitutes for Vivian (comma-separated)"
        style="margin-left: 10px; width: 200px;"><br><label><input type="checkbox" name="vipSelect" value="Ruby">
        Ruby</label><input type="text" id="subs_Ruby" placeholder="Substitutes for Ruby (comma-separated)"
        style="margin-left: 10px; width: 200px;"><br></div>
    <button onclick="recordExpense()" class="btn">Record This Session</button>

    <h3>Current Status</h3>
    <p id="originalBalance">Original Balance: <span class="balance-amount">RMB 34500.00</span></p>
    <p id="totalBalance">Total Remaining Balance: <span class="balance-amount">RMB 33190.00</span></p>
    <table id="statusTable">
      <thead>
        <tr>
          <th>Member</th>
          <th>每次结算金额</th>
          <th>Points</th>
        </tr>
      </thead>
      <tbody id="balanceTable"></tbody>
    </table>

    <h3>Expense History</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Session</th>
          <th>Date</th>
          <th>Hours</th>
          <th>Time Period</th>
          <th>Rate/Hour</th>
          <th>VIP Participants</th>
          <th>Per Person Deduction (RMB)</th>
          <th>Points Earned</th>
          <th>每次结算金额 </th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <h3>Substitutes History</h3>
    <table id="substitutesTable">
      <thead>
        <tr>
          <th>Substitute Name</th>
          <th>Total Hours</th>
          <th>Total Points</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="exportToExcel()" class="btn">Export to Excel</button>
    <button onclick="saveHtmlFile()" class="btn">Save HTML File</button>

    <h4>
      VIP 6位会员运行规则
      <ul>
        <li>1. 一场一结算：每一场活动单独结算。</li>
        <li>2. 总价：记为 X。</li>
        <li>3. 参与人数：记为 Y（包含会员与非会员）。</li>
        <li>4. 参与情况：</li>
        <ul>
          <li>非会员参与者应付：X / Y</li>
          <li>VIP参与者应付：X / Y - X / 6</li>
        </ul>
        <li>5. 未参与的VIP成员：Blue 将总收入平均分配给这些未参与的VIP会员，每位未参与的VIP成员应收X/6。</li>
      </ul>。
    </h4>
  </div>

  <script>
    let balances = {};
    let points = {}; // 新增积分跟踪
    let vipList = [];
    let eventCounter = 1; // 修改为2，因为HTML中显示Session #2
    let substitutesTotals = {}; // 替代人员累积统计：{name: {hours: total, points: total}}
    const pointsPerHour = 10; // 每小时10积分

    let originalBalance = 34500.00; // 初始总余额

    // 初始化预设数据
    function initializePresetData() {
      vipList = ['Blue', 'Guo', 'Pi', 'Eva', 'Vivian', 'Ruby'];
      balances = {
        'Blue': 5610.00,   // 已参加第一场比赛，扣除140
        'Guo': 5750.00,    // 未参加第一场比赛
        'Pi': 5610.00,     // 已参加第一场比赛，扣除140
        'Eva': 5610.00,    // 已参加第一场比赛，扣除140
        'Vivian': 5750.00, // 未参加第一场比赛
        'Ruby': 5610.00    // 已参加第一场比赛，扣除140
      };
      // 初始化积分，基于现有历史数据
      points = {
        'Blue': 0,   // 参加了第一场2小时比赛
        'Guo': 0,
        'Pi': 0,     // 参加了第一场2小时比赛
        'Eva': 0,    // 参加了第一场2小时比赛
        'Vivian': 0,
        'Ruby': 0    // 参加了第一场2小时比赛
      };
    }

    // 页面加载时初始化
    window.addEventListener('DOMContentLoaded', function () {
      initializePresetData();
       updateBalanceTable(0);

    });

    function initializeSession() {
      const names = document.getElementById('vipNames').value.split(',').map(n => n.trim()).filter(Boolean);
      const initial = parseFloat(document.getElementById('initialAmount').value);
      if (names.length === 0 || isNaN(initial)) {
        alert('Please enter valid VIP names and initial amount.');
        return;
      }
      vipList = names;
      balances = {};
      points = {}; // 初始化积分
      names.forEach(name => {
        balances[name] = initial;
        points[name] = 0; // 初始积分为0
      });
      updateBalanceTable(0);
      createVipCheckboxes();
      document.getElementById('mainSection').style.display = 'block';
      document.getElementById('initBtn').disabled = true;
    }

    function createVipCheckboxes() {
      const container = document.getElementById('vipCheckboxes');
      container.innerHTML = '<label>Select VIP Participants:</label><br>';
      vipList.forEach(name => {
        container.innerHTML += `<label><input type="checkbox" name="vipSelect" value="${name}"> ${name}</label><input type="text" id="subs_${name}" placeholder="Substitutes for ${name} (comma-separated)" style="margin-left: 10px; width: 200px;"><br>`;
      });
    }

    // 新增：记录每次结算金额
    let lastSettlement = {};

    function updateBalanceTable(totalCost) {
      const tbody = document.getElementById('balanceTable');
      tbody.innerHTML = '';
      let total = 0;
      for (const p of vipList) {
        if (balances[p] !== undefined && !isNaN(balances[p])) {
          total += balances[p];
          const memberPoints = points[p] || 0;
          // 显示每次结算金额
          let settlementStr = '';
          if (lastSettlement[p] !== undefined) {
            if (lastSettlement[p] > 0) {
              settlementStr = `应收：${lastSettlement[p].toFixed(2)}`;
            } else if (lastSettlement[p] < 0) {
              settlementStr = `应付：${(-lastSettlement[p]).toFixed(2)}`;
            } else {
              settlementStr = '0.00';
            }
          } else {
            settlementStr = '-';
          }
          tbody.innerHTML += `<tr><td>${p}</td><td>${settlementStr}</td><td>${memberPoints}</td></tr>`;
        }
      }
      console.log(originalBalance, totalCost, total);
      document.getElementById('totalBalance').innerHTML = `Total Remaining Balance: <span class="balance-amount">RMB ${originalBalance - totalCost}</span>`;
      document.getElementById('originalBalance').innerHTML = `Original Balance: <span class="balance-amount">RMB ${originalBalance.toFixed(2)}</span>`;
    }

    function updateSubstitutesTable() {
      const tbody = document.querySelector('#substitutesTable tbody');
      tbody.innerHTML = '';
      Object.keys(substitutesTotals).forEach(name => {
        const totals = substitutesTotals[name];
        const row = document.createElement('tr');
        row.innerHTML = `<td>${name}</td><td>${totals.hours}</td><td>${totals.points}</td>`;
        tbody.appendChild(row);
      });
    }

    function recordExpense() {
      const date = document.getElementById('sessionDate').value;
      const hours = parseFloat(document.getElementById('hours').value);
      const selectedVIPs = Array.from(document.querySelectorAll('input[name="vipSelect"]:checked')).map(i => i.value);

      // 获取选择的时段并设置相应费率
      const timePeriod = document.querySelector('input[name="timePeriod"]:checked').value;
      const ratePerHour = timePeriod === 'peak' ? 280 : 190;

      // 收集每个VIP的substitute信息（暂不处理substitute，按VIP结算规则）
      // ...existing code...

      if (selectedVIPs.length === 0 || isNaN(hours) || !date) {
        alert('请填写完整日期、参与VIP和小时数。');
        return;
      }

      const totalCost = hours * ratePerHour;
      const vipCount = selectedVIPs.length;
      const allVIPCount = vipList.length;
      const notInvolvedVIPs = vipList.filter(vip => !selectedVIPs.includes(vip));

      // 结算：未参与的VIP每人应收 totalCost / allVIPCount
      const notInvolvedGet = totalCost / allVIPCount;
      // 参与VIP每人应付 totalCost / vipCount - totalCost / allVIPCount
      const involvedPay = totalCost / vipCount - notInvolvedGet;

      // 记录每次结算金额
      lastSettlement = {};
      vipList.forEach(vip => {
        if (selectedVIPs.includes(vip)) {
          balances[vip] -= involvedPay;
          lastSettlement[vip] = -involvedPay; // 应付
        } else {
          balances[vip] += notInvolvedGet;
          lastSettlement[vip] = notInvolvedGet; // 应收
        }
      });

      // 积分：参与VIP获得积分
      selectedVIPs.forEach(vip => {
        points[vip] = (points[vip] || 0) + (hours * pointsPerHour);
      });

      // 生成积分记录字符串
      let pointsRecords = [];
      selectedVIPs.forEach(vip => {
        const vipPoints = hours * pointsPerHour;
        pointsRecords.push(`${vip}: +${vipPoints}`);
      });
      const pointsRecord = pointsRecords.join(', ') || '-';

      // 生成扣费信息
      let costDisplay = '';
      if (selectedVIPs.length > 0) {
        costDisplay += `VIP参与者: ${involvedPay.toFixed(2)}; `;
      }
      if (notInvolvedVIPs.length > 0) {
        costDisplay += `未参与VIP: +${notInvolvedGet.toFixed(2)}`;
      }

      const timePeriodText = timePeriod === 'peak' ? '黄金时段' : '非黄金时段';
      // 生成6个会员结算结果字符串
      let settlementResults = vipList.map(vip => {
        if (lastSettlement[vip] !== undefined) {
          if (lastSettlement[vip] > 0) {
            return `${vip}: +${lastSettlement[vip].toFixed(2)}`;
          } else if (lastSettlement[vip] < 0) {
            return `${vip}: -${(-lastSettlement[vip]).toFixed(2)}`;
          } else {
            return `${vip}: 0.00`;
          }
        } else {
          return `${vip}: -`;
        }
      }).join(', ');

      const row = document.createElement('tr');
      row.innerHTML = `<td>${eventCounter}</td><td>${date}</td><td>${hours}</td><td>${timePeriodText}</td><td>${ratePerHour}</td><td>${selectedVIPs.join(', ')}</td><td>${costDisplay}</td><td>${pointsRecord}</td><td>${settlementResults}</td>`;
      document.querySelector('#historyTable tbody').appendChild(row);

      eventCounter++;
      document.getElementById('eventId').innerText = eventCounter;
      updateBalanceTable(totalCost);
      // ...existing code...
    }

    function exportToExcel() {
      let csv = "Current VIP Status\nMember,Card Balance (RMB),Points\n";
      vipList.forEach(name => {
        csv += `${name},${balances[name].toFixed(2)},${points[name] || 0}\n`;
      });
      csv += "\nExpense History\n";

      const headers = Array.from(document.querySelectorAll('#historyTable thead th')).map(th => th.innerText);
      csv += headers.join(',') + "\n";

      const rows = document.querySelectorAll('#historyTable tbody tr');
      rows.forEach(row => {
        const cols = Array.from(row.querySelectorAll('td')).map(td => td.innerText);
        csv += cols.join(',') + "\n";
      });

      csv += "\nSubstitutes History\n";
      csv += "Substitute Name,Total Hours,Total Points\n";
      Object.keys(substitutesTotals).forEach(name => {
        const totals = substitutesTotals[name];
        csv += `${name},${totals.hours},${totals.points}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "vip_expense_report.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function saveHtmlFile() {
      const html = document.documentElement.outerHTML;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'vip_tracker_snapshot.html';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  </script>

</body>

</html>